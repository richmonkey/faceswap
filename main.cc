#include <iostream>
#include <inspireface.h>
#include <herror.h>
#include "face_swap.h"

float source_bbox[] = {660.5451, 174.8821, 927.83734, 528.8127};
float source_kps[][2] = {{770.26636, 310.94568},
                         {882.255, 320.83176},
                         {845.0048, 382.694},
                         {777.7395, 452.85153},
                         {863.74695, 459.83292}};

float source_embding[] = {
    7.09387779e-01,  -5.33892930e-01, -4.17487733e-02, 2.08117199e+00,  -8.20535868e-02,
    -1.27236426e-01, -1.82735431e+00, -1.93290144e-01, 6.43412590e-01,  3.93391818e-01,
    1.45453525e+00,  1.01549096e-01,  -7.85235405e-01, -2.49603677e+00, 1.53785527e+00,
    1.93079245e+00,  1.22928452e+00,  -7.33279407e-01, -5.50827146e-01, -6.99346438e-02,
    -1.34484202e-01, 4.83515084e-01,  -4.85691011e-01, -5.06537795e-01, -2.65254110e-01,
    1.01236486e+00,  1.84283793e+00,  -4.35824811e-01, -9.27771270e-01, 1.71637988e+00,
    2.34053206e+00,  -9.97425795e-01, -5.83406627e-01, 1.44532156e+00,  -1.44000852e+00,
    2.13327184e-01,  -4.83097881e-02, 1.27111411e+00,  -1.28582671e-01, -5.23757994e-01,
    -5.02285719e-01, 4.54925269e-01,  -6.60048604e-01, 8.44797432e-01,  -2.49325871e-01,
    5.46357274e-01,  1.36268973e+00,  -4.54823971e-01, 2.85542458e-01,  1.51657486e+00,
    1.78474009e+00,  -1.00551224e+00, 1.70655966e+00,  -4.22531128e-01, -8.42777729e-01,
    -8.62589955e-01, -1.30468690e+00, 3.00689624e-03,  -8.57702494e-01, 7.88111910e-02,
    3.41465563e-01,  -1.05628490e+00, 9.03358281e-01,  6.06655717e-01,  9.24888313e-01,
    2.63334870e-01,  -6.32265687e-01, -1.60868061e+00, 5.22138000e-01,  5.40980883e-02,
    -2.62101501e-01, 1.32035172e+00,  -7.94885635e-01, -4.80851144e-01, -4.99561131e-02,
    1.38360918e-01,  -5.77397168e-01, -1.69969761e+00, 7.84241676e-01,  5.92963874e-01,
    -1.19378781e+00, 1.53915241e-01,  1.14855123e+00,  -3.78285572e-02, -7.75302887e-01,
    7.38972843e-01,  -3.42240073e-02, 9.36261177e-01,  -1.93220049e-01, -3.39712724e-02,
    2.28079215e-01,  5.35355747e-01,  1.16066225e-01,  -8.64119589e-01, 1.15293480e-01,
    1.13410091e+00,  -5.89133680e-01, -8.83291185e-01, 1.79664242e+00,  3.42184603e-01,
    -1.01201761e+00, -6.46208227e-01, 1.87809676e-01,  -8.29138756e-01, -2.73220450e-01,
    -2.66332000e-01, 1.55824459e+00,  -1.87019742e+00, 2.24142194e-01,  2.56451219e-01,
    -1.76861000e+00, 9.47850108e-01,  -4.87732887e-01, -6.65190935e-01, -1.41591322e+00,
    -3.44526470e-01, 8.25495422e-02,  3.28260511e-02,  1.53004184e-01,  -1.00573397e+00,
    -3.58861476e-01, -4.84573394e-01, -5.50842941e-01, 3.81426662e-01,  -1.91573238e+00,
    -8.28886151e-01, 3.41866165e-01,  9.99260068e-01,  -2.21076775e-02, 4.56871152e-01,
    -5.00000954e-01, -2.60689914e-01, 4.67701048e-01,  5.93506634e-01,  -6.51355088e-02,
    -5.29323399e-01, -1.43674761e-01, -3.28302711e-01, -7.64460921e-01, 2.96337456e-01,
    -1.18457997e+00, 1.64528143e+00,  9.85070169e-01,  -6.55713737e-01, -6.08046949e-01,
    5.60000062e-01,  8.85488629e-01,  -9.25995335e-02, 5.10647535e-01,  7.11018980e-01,
    -3.60319555e-01, -1.62545457e-01, -1.33441627e-01, 1.16323280e+00,  9.38771307e-01,
    -2.04135045e-01, 3.81830305e-01,  -7.37730488e-02, -1.77608550e+00, -1.74102277e-01,
    -1.22411537e+00, 6.87546432e-01,  -1.31157386e+00, -3.99364799e-01, 3.05845946e-01,
    1.29230320e-01,  -5.62598109e-02, 5.51543891e-01,  -3.44566166e-01, -1.59859848e+00,
    1.07662010e+00,  5.93962729e-01,  -3.54910076e-01, -4.35107291e-01, 4.01434004e-01,
    1.23352014e-01,  -9.03383195e-01, 1.64745998e+00,  1.50794581e-01,  1.20217097e+00,
    4.11530137e-01,  2.26019478e+00,  -6.89134359e-01, -1.15043044e-01, 4.96715680e-02,
    -1.37487102e+00, 1.78117681e+00,  6.15924239e-01,  8.58337104e-01,  3.03258002e-01,
    7.88306475e-01,  -6.23007178e-01, 2.65723795e-01,  -1.17199445e+00, -3.83139163e-01,
    -5.82277894e-01, 2.23020458e+00,  4.94981021e-01,  4.29601073e-01,  -9.04599857e-03,
    8.98481548e-01,  1.29380453e+00,  1.74003676e-01,  -9.88467708e-02, -7.20742345e-01,
    -1.58745265e+00, -5.77931166e-01, -2.77624696e-01, -1.64096355e+00, 1.78945065e-01,
    -3.88767987e-01, -1.08560085e+00, 1.61324787e+00,  1.39809775e+00,  -8.42440009e-01,
    -3.86819661e-01, -3.04960519e-01, -2.19064727e-01, 8.14033270e-01,  -3.32857192e-01,
    -5.06342709e-01, -1.28607512e+00, -4.10734147e-01, -2.99485892e-01, -3.13876152e-01,
    -6.42568052e-01, -3.65001827e-01, -1.16784489e+00, 7.73844600e-01,  3.10596824e-01,
    -1.74260831e+00, -8.47967207e-01, 3.47075254e-01,  9.39368069e-01,  8.05658460e-01,
    5.34242630e-01,  1.42053008e-01,  -4.11906064e-01, 1.12167329e-01,  -1.03847718e+00,
    -8.29292774e-01, 6.06781781e-01,  1.31774831e+00,  9.38381433e-01,  7.45703757e-01,
    4.88760203e-01,  1.36832035e+00,  4.02554899e-01,  9.47485864e-01,  8.84475887e-01,
    -1.85488486e+00, -4.34046239e-01, -8.19708705e-01, -1.56661403e+00, 7.29329348e-01,
    -1.30342737e-01, 1.35404563e+00,  9.82370973e-01,  8.40161085e-01,  6.00694597e-01,
    -1.29212272e+00, 1.78082809e-01,  -1.68972111e+00, 8.34892988e-01,  3.68832052e-01,
    1.02284908e+00,  -1.55446827e+00, -1.67517699e-02, 3.13318297e-02,  2.28912306e+00,
    -1.45430124e+00, -5.30663311e-01, 4.26963300e-01,  -1.76726317e+00, 1.98916006e+00,
    -1.06803405e+00, 1.42151046e+00,  6.10632837e-01,  1.09143078e+00,  6.93103313e-01,
    -2.73039043e-02, -1.38583744e+00, -3.29215527e-01, -9.38464105e-01, 3.54298316e-02,
    8.53668869e-01,  -8.81510496e-01, -3.89660567e-01, 2.84117609e-02,  -6.46313131e-01,
    -1.39666605e+00, -1.41143930e+00, 4.78615552e-01,  -1.82289369e-02, -3.82371575e-01,
    -2.64930110e-02, 1.24686491e+00,  -1.60922992e+00, 7.03013480e-01,  1.44846618e+00,
    -8.20822060e-01, 6.50944769e-01,  1.38395464e+00,  2.48337254e-01,  -5.03461296e-03,
    9.50943112e-01,  -2.57861823e-01, 4.83926743e-01,  -1.64217204e-01, 9.86387312e-01,
    -8.79659355e-02, 5.69164097e-01,  2.48391569e-01,  -1.64486349e-01, -4.72938359e-01,
    -1.27083749e-01, 3.08451593e-01,  9.81194794e-01,  8.94900799e-01,  -6.42488122e-01,
    5.40079415e-01,  1.02869105e+00,  -8.87892544e-01, -3.15753967e-01, -6.10566974e-01,
    -8.96713734e-01, -1.10027158e+00, -2.04441977e+00, 2.62443632e-01,  1.31958699e+00,
    -1.13022041e+00, -4.34213966e-01, 6.72071636e-01,  4.77624461e-02,  -1.29519606e+00,
    -7.02522039e-01, -6.62645757e-01, -1.31190932e+00, -1.53967583e+00, -6.05568469e-01,
    4.93340015e-01,  -9.61459279e-01, -2.92208135e-01, 8.25099885e-01,  -4.18871462e-01,
    -5.47777653e-01, -1.46342409e+00, -4.43737537e-01, 3.04642804e-02,  5.92550218e-01,
    -1.26749146e+00, -3.77174705e-01, 9.23234522e-01,  -5.20274341e-01, 1.12567544e+00,
    1.82889625e-02,  -1.37344015e+00, 2.71147639e-01,  4.47416276e-01,  7.78362274e-01,
    1.60343337e+00,  2.89677382e-01,  -8.36648583e-01, 6.14546835e-02,  -6.49466179e-03,
    -6.44706905e-01, -7.53699660e-01, -1.34023654e+00, 8.23530197e-01,  -9.82390821e-01,
    -1.12736809e+00, 2.10804567e-01,  -7.41141498e-01, 4.01388347e-01,  -1.30485988e+00,
    1.61821440e-01,  -2.62791459e-02, 6.71005487e-01,  4.52358238e-02,  -3.50764841e-01,
    1.25682175e+00,  3.55671227e-01,  -3.61458445e-03, -6.09967858e-02, -1.16363132e+00,
    -4.42151397e-01, 1.59171775e-01,  7.73721159e-01,  -2.49499828e-01, 4.93388593e-01,
    3.16341567e+00,  -1.21203399e+00, -1.77462924e+00, 2.47047022e-01,  -7.23908901e-01,
    -6.32722259e-01, -6.34216845e-01, -2.10573543e-02, -1.09134102e+00, -1.18098772e+00,
    -1.07617497e+00, 9.81451929e-01,  -6.55295730e-01, 8.34936947e-02,  -2.41171926e-01,
    5.69435991e-02,  -4.90084440e-01, -2.69828051e-01, -7.69710541e-01, 1.23378134e+00,
    1.18765080e+00,  -2.11962789e-01, 1.36492208e-01,  -4.13777046e-02, -3.01787883e-01,
    -6.59040987e-01, -1.11003732e-02, -3.45506459e-01, -1.04882753e+00, -1.70513883e-01,
    -5.37890434e-01, -1.13711512e+00, -6.05442584e-01, 6.53434634e-01,  7.69347847e-01,
    2.22515321e+00,  -2.41024673e-01, 4.06240821e-02,  -7.72136629e-01, -7.81530887e-02,
    -1.29738522e+00, 1.01661170e+00,  -1.86570287e-01, 7.51086414e-01,  1.41914606e-01,
    3.45476985e-01,  -6.71752095e-01, -3.53632808e-01, -4.59388256e-01, 4.56740826e-01,
    -8.19522083e-01, -8.13701034e-01, -1.58894688e-01, -5.83891988e-01, 6.13439679e-01,
    2.81561583e-01,  4.24348682e-01,  1.16192162e-01,  9.87783492e-01,  1.01627402e-01,
    -1.71458018e+00, 4.26287860e-01,  -2.73977607e-01, 7.29870439e-01,  -2.48745012e+00,
    -1.06562865e+00, -2.47174215e+00, -4.69883531e-01, 6.04961812e-01,  -2.17702582e-01,
    -1.34553516e+00, -1.11742187e+00, -1.44761026e+00, 1.91078424e-01,  7.78749585e-01,
    -7.68159270e-01, 2.47360754e+00,  1.14237845e+00,  1.08271468e+00,  1.00877225e+00,
    -9.22457695e-01, -3.30614805e-01, -2.92984098e-02, 7.57066071e-01,  6.42346382e-01,
    -7.73500651e-02, 9.46092010e-01,  1.02402496e+00,  9.28484142e-01,  2.36006245e-01,
    1.22717822e+00,  -4.81177028e-03, -8.73697162e-01, 2.36677825e-02,  -2.32094944e-01,
    -1.41507447e+00, -1.03553879e+00, -1.34740400e+00, -1.96859014e+00, 1.01952255e+00,
    -1.23426616e+00, -1.36725211e+00, 1.85096473e-01,  5.31575620e-01,  -7.87041426e-01,
    -9.30697992e-02, -5.55460572e-01, 2.08508834e-01,  -2.39103556e+00, -1.05751872e+00,
    2.02512193e+00,  -1.67436802e+00, -7.56567538e-01, 8.07691813e-01,  -3.31052750e-01,
    2.84639210e-01,  -2.50270337e-01, -1.81923077e-01, 8.84610787e-02,  9.93460298e-01,
    -2.39315033e-01, 9.99883175e-01};

float target_bbox[] = {192.96284, 106.36309, 334.37723, 307.58255};
float target_kps[][2] = {{223.71083, 191.16725},
                         {284.47855, 187.32207},
                         {251.15047, 228.59239},
                         {233.80948, 259.97726},
                         {287.35388, 256.0052}};

float target_embedding[] = {
    0.9466131,   0.3650591,   -0.3488828,  -0.8714912,  1.245859,    -0.3471453,  0.6249656,
    1.2894012,   0.8968978,   0.6068602,   0.43473956,  1.6126707,   -0.18429412, -1.1860735,
    0.8775868,   0.02717938,  -0.45603806, 1.2055244,   -0.1309496,  1.4352391,   0.4806356,
    1.1288399,   0.65551376,  -0.06904849, -0.47625747, -1.6096946,  -0.6275102,  -0.6333844,
    -1.4931287,  0.01254431,  0.7349137,   0.8921556,   -0.18796998, -0.61234736, -1.3626305,
    0.27837485,  -0.08501537, 0.770538,    -1.8743243,  0.60119253,  0.45768946,  -1.6312994,
    -1.0628139,  -0.38013008, -0.7255866,  -0.5997812,  -0.32247987, -1.0590162,  0.4162016,
    0.6307936,   0.41155714,  0.01964816,  1.602775,    0.18286715,  0.8561216,   -0.36295858,
    -0.03701238, -0.13304347, -0.07516803, 0.56691784,  -0.78139037, -1.6100246,  -0.57564837,
    1.5345582,   -1.5958732,  -0.48649353, 0.5254217,   0.13196254,  -1.137355,   1.5569775,
    0.26982912,  2.3168666,   -0.74032784, -0.6972508,  0.32068032,  0.5496207,   0.4459713,
    1.3242671,   -0.28290224, -0.25138986, -1.0154421,  -0.38063234, -0.7443363,  0.94599247,
    0.42665133,  -1.2546103,  0.96425456,  -0.44188806, -0.6300659,  -0.35500538, -1.1971877,
    0.5460136,   0.6193634,   -0.82146364, 0.92834175,  -0.7307367,  -0.48738632, -0.12176828,
    -1.0043939,  -0.12301794, 0.17348826,  -0.1714001,  -0.24324037, 0.01074837,  0.05247804,
    0.8250915,   0.35353827,  -0.458616,   -0.6047289,  0.5189456,   -1.9257821,  -0.15994275,
    -0.05573329, 0.92854977,  -0.38190842, 0.7586381,   1.1231589,   -1.0926906,  1.2085413,
    -0.3427896,  0.64121807,  0.6039883,   1.2885566,   0.5991611,   -0.80072975, 0.4914901,
    0.07202376,  0.12002978,  -0.7452599,  1.5615429,   1.596117,    0.00235882,  -0.6292351,
    -1.4638602,  -1.2462867,  -0.53934413, 1.0220345,   -0.47499785, 0.15055123,  0.45865288,
    -1.6009412,  0.28668192,  -0.9506258,  1.3694987,   2.1995583,   0.20888908,  0.3469735,
    0.00795539,  -0.8723308,  -1.4648051,  0.3330688,   0.11350744,  0.32692045,  -0.46677864,
    -0.49882555, -0.85267353, -1.9433517,  0.53347385,  0.11819299,  0.91685534,  -1.3049806,
    -0.23075646, -1.1909351,  0.6377855,   -0.12769438, 1.7446285,   -0.43719965, -0.40241605,
    1.223395,    0.35344243,  0.9729968,   -1.1097336,  0.09284975,  1.1292738,   -0.52246416,
    0.8090585,   -0.18700537, 0.6346689,   1.3690414,   -0.5302646,  0.22952399,  -0.9689759,
    -1.2374802,  -1.4436814,  0.6645164,   1.6755272,   0.0636653,   -1.0472876,  -0.20010106,
    -0.3999796,  -0.23333466, -0.22306517, -1.3737563,  -0.9755716,  -0.5028168,  -0.00421933,
    -0.7059844,  0.04171019,  0.2794839,   0.9999682,   1.0145394,   -0.8296188,  0.34178802,
    0.8812444,   1.3131071,   0.03280006,  0.77387816,  -0.01031389, 0.40277305,  -0.21127684,
    0.86509895,  -0.8285934,  0.11915272,  -0.4622106,  0.48524055,  -0.6953106,  0.04094218,
    -0.05071002, -1.0512978,  0.8938151,   0.76848644,  0.5883036,   0.57309055,  0.07803182,
    -1.2962296,  -0.12449963, -1.0362542,  0.24220857,  -1.0248603,  0.18236864,  -1.4498912,
    -0.7418624,  2.1733668,   -2.2097852,  0.23844483,  0.8744426,   -0.87057024, -1.8257003,
    0.23286444,  -0.7713386,  -1.5986571,  0.43887338,  0.7506743,   0.37160143,  0.695121,
    -0.35385627, 0.911211,    0.32861453,  0.36977467,  0.45191213,  1.0540671,   0.02392953,
    -0.01439929, 0.4215435,   -0.7760131,  0.04502087,  -0.59351844, -1.9060835,  1.1820731,
    0.4762193,   0.23972973,  -0.5373568,  -1.1180952,  -1.2794633,  0.7443443,   0.8275067,
    0.5772715,   1.4703978,   0.03060254,  -0.36010265, -0.2992781,  0.28509042,  0.05521866,
    1.1553227,   2.120363,    -0.14706312, -0.336847,   -1.8440495,  -0.30048198, 0.15120853,
    -0.48229587, 0.28670803,  0.1979036,   -0.26540613, -0.47043648, -0.20501857, -0.4207139,
    0.6226472,   0.02441335,  -0.26103467, 1.1108704,   -0.41259784, 0.6687766,   0.8343963,
    1.7594874,   -0.47124347, -0.05009666, 0.616314,    -1.1344539,  0.51685363,  -0.24420723,
    -0.29456306, 0.82294565,  0.29951707,  0.35645473,  0.14808278,  0.847798,    0.08276521,
    -0.5309545,  -1.0467741,  0.6436037,   -0.9428179,  0.9851642,   1.0837226,   -0.9074533,
    0.2925795,   -1.5434693,  -0.46229586, 0.31749323,  -0.90907604, -1.2101531,  0.27705365,
    0.41106138,  0.25564557,  0.14729115,  0.99009675,  0.58581936,  0.3940791,   -1.7734998,
    -0.11171407, 0.56757504,  0.57997066,  0.4794289,   -0.8101357,  -0.30332583, 0.24594976,
    -1.1057202,  -1.0615513,  -0.4518623,  0.8620529,   -0.98182327, -0.357899,   -0.8822439,
    0.7039392,   1.3200631,   0.63673985,  -0.15945023, 1.257534,    -2.1314588,  0.5138301,
    0.23538138,  0.5555333,   -0.11443201, 0.3987371,   1.2590647,   -0.41886804, 0.45852622,
    -0.02742111, 0.4723499,   2.0109885,   -1.5657408,  -0.0613743,  0.3313705,   0.2669731,
    1.0009562,   0.04365097,  1.5963136,   0.14458683,  -0.08924623, -0.2880664,  -0.55930465,
    -0.59445316, 0.5417923,   -0.80822784, -0.43820578, 1.3180408,   0.73735684,  -1.1729897,
    -0.09437583, -1.2521421,  -1.0399944,  0.38351247,  -0.78142136, -0.60618955, -0.35497904,
    0.46821448,  0.7079837,   0.35876715,  0.21737786,  -0.85683113, -0.8204492,  -0.25106,
    -1.5067322,  0.17984785,  0.49871936,  1.2571272,   0.0696599,   0.935719,    -0.6851033,
    -0.94339776, -0.4079203,  0.8807486,   0.74716663,  -0.14512908, -0.86813354, 1.0198181,
    0.13427523,  -2.178133,   0.46326175,  0.14402626,  0.86025953,  -0.28237045, 0.7768494,
    1.6210691,   0.8700458,   -0.29885587, -0.15196624, 0.70584977,  1.0719528,   0.31181124,
    0.9227632,   -0.01819704, 0.6532336,   -1.2101438,  0.7292696,   -1.1953521,  0.23646443,
    -1.0493803,  -1.8466305,  0.10833626,  -1.111033,   0.6527775,   -0.93837446, 1.052681,
    0.22496648,  -1.3101586,  0.1134093,   1.0168797,   0.7926637,   0.4153721,   0.40947333,
    -0.21865049, -0.6106657,  0.00496259,  0.34278637,  0.25741112,  -0.5719856,  0.2419483,
    -0.97630167, 0.07739627,  -0.4816817,  0.14397188,  -1.3266923,  0.3484826,   -0.1710538,
    1.0856836,   1.0821182,   -2.137707,   0.59632695,  -0.5482214,  -0.4420685,  1.262591,
    -0.70834136, -0.59441406, 0.8092113,   -1.4160833,  -0.02106686, -0.00861735, -1.3234178,
    0.21837544,  1.358505,    -0.23299283, 0.7627293,   0.99937785,  -0.5337244,  0.2308109,
    0.5127168,   -0.42633104, -0.95094854, -0.23144722, 0.7656296,   -0.0153596,  -0.70169014,
    1.4710988,   0.2748156,   -0.62210107, 0.00851959,  -0.16696078, 1.3771111,   -0.38520226,
    0.46584916,  -0.6670771,  0.69087094,  0.8086589,   -0.22470145, 0.6570404,   1.3105011,
    0.6687985,   0.5911003,   -1.2383618,  -0.20572619, -1.2732065,  0.06373263,  0.35624307,
    0.5318327,   0.43886077,  -1.5747447,  -0.75964767, -0.6215068,  -1.1590668,  -1.2961987,
    0.5684634};

int main() {
    // 模型路径 - 需要替换为实际路径
    std::string detection_model = "models/Megatron";
    std::string swap_model = "models/inswapper_128.onnx";

    // 初始化换脸器
    FaceSwap face_swapper(swap_model);

    if (!face_swapper.Initialize()) {
        std::cerr << "Failed to initialize face swapper!" << std::endl;
        return -1;
    }

    std::string source_path = "source.jpg";
    std::string target_path = "target.jpg";
    // 加载图像
    cv::Mat source_image = cv::imread(source_path);

    cv::Mat target_image = cv::imread(target_path);

    if (source_image.empty() || target_image.empty()) {
        std::cerr << "Failed to load images!" << std::endl;
        return -1;
    }

    Face src_face;
    src_face.embedding = std::vector(
        source_embding, source_embding + sizeof(source_embding) / sizeof(source_embding[0]));

    memcpy(src_face.kps, source_kps, 10 * sizeof(float));

    src_face.x1 = source_bbox[0];
    src_face.y1 = source_bbox[1];
    src_face.x2 = source_bbox[2];
    src_face.y2 = source_bbox[3];

    Face target_face;
    target_face.embedding =
        std::vector(target_embedding,
                    target_embedding + sizeof(target_embedding) / sizeof(target_embedding[0]));
    memcpy(target_face.kps, target_kps, 10 * sizeof(float));
    target_face.x1 = target_bbox[0];
    target_face.y1 = target_bbox[1];
    target_face.x2 = target_bbox[2];
    target_face.y2 = target_bbox[3];

    face_swapper.Process(target_image, src_face, target_face);

    return 0;
}
